name: deploy
on:
  push:
    branches:
      - main
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false
permissions:
  id-token: write # This is required for requesting the JWT
  contents: read
  packages: write

jobs:
    deploy:
      name: Deploy Application
      runs-on: ubuntu-latest
      environment: ${{ github.ref_name }}
      steps:
        - name: Checkout the repo
          uses: actions/checkout@v3

        - name: Install doctl
          uses: digitalocean/action-doctl@v2
          with:
            token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

        - name: Install Build Script Dependencies
          run: rm package.json package-lock.json && npm install zx js-yaml lodash

        - name: Pre-Build
          run: npm run prebuild
        
        - name: Build image
          run: docker build --platform linux/amd64 -t boxyhq/jackson:latest .

        - name: Tag image
          run: docker tag boxyhq/jackson:latest registry.digitalocean.com/auditive/auditive-sso:latest

        - name: Push image
          run: docker push registry.digitalocean.com/auditive/auditive-sso:latest
